<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if is_logged_in %}食堂混雑状況{% else %}参加者ログイン{% endif %}</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background-color: #ffffff;
      color: #333333;
      margin: 0;
      padding: 20px;
      text-align: center;
      width: 100vw;
      min-height: 100vh;
      box-sizing: border-box;
    }

    body.login-mode {
      background-color: #f8f9fa;
    }

    .login-container {
      max-width: 400px;
      margin: 50px auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .login-input {
      font-size: 1.5em;
      width: 80%;
      padding: 10px;
      margin: 20px 0;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .login-button {
      font-size: 1.2em;
      padding: 10px 40px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      position: relative;
    }

    .title {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 3px solid #eeeeee;
    }

    .info-text {
      font-size: 1.1em;
      margin: 8px 0;
      text-align: left;
      padding-left: 20px;
    }

    #service-time {
      font-size: 1.5em;
      margin-bottom: 10px;
      text-align: center;
      padding-left: 0;
    }

    .menu-text {
      text-align: center;
      margin-bottom: 12px;
      font-size: 1.3em;
    }

    .congestion-icon-section {
      margin: 25px auto 15px auto;
      width: 200px;
      height: 140px;
      padding: 16px 18px;
      border-radius: 10px;
      background-color: #f9f9f9;
      border: 2px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    #congestion-icons {
      font-size: 3.0em;
      display: flex;
      justify-content: center;
      gap: 18px;
    }

    #congestion-icons i {
      margin: 0;
    }

    #congestion-icons .icon-inactive {
      color: #e0e0e0;
    }

    #congestion-text {
      font-size: 1.8em;
      font-weight: bold;
      margin-top: 6px;
    }

    .level-1 {
      color: #007bff;
    }

    .congestion-icon-section.level-1 {
      background-color: #e7f1ff;
    }

    .wait-time.level-1 {
      color: #007bff;
    }

    .level-2 {
      color: #ffc107;
    }

    .congestion-icon-section.level-2 {
      background-color: #fff7d6;
    }

    .wait-time.level-2 {
      color: #ffc107;
    }

    .level-3 {
      color: #dc3545;
    }

    .congestion-icon-section.level-3 {
      background-color: #ffe5e5;
    }

    .wait-time.level-3 {
      color: #dc3545;
    }

    .level-off {
      color: #6c757d;
    }

    .congestion-icon-section.level-off {
      background-color: #f2f2f2;
    }

    .wait-time.level-off {
      color: #6c757d;
    }

    .wait-time-section {
      margin: 20px 0;
    }

    .wait-label {
      font-size: 1.8em;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .wait-time {
      font-size: 3.2em;
      font-weight: bold;
      font-variant-numeric: tabular-nums;
    }

    .prediction-text {
      font-size: 1.8em;
      margin: 14px 0;
      line-height: 1.5;
      text-align: center;
      display: none;
    }

    #pred-crowd-area {
      color: #dc3545;
      font-weight: bold;
    }

    #pred-empty-area {
      color: #007bff;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .title {
        font-size: 2.0em;
      }

      #service-time {
        font-size: 1.3em;
      }

      .menu-text {
        font-size: 1.0em;
      }

      #congestion-icons {
        font-size: 2.5em;
        gap: 14px;
      }

      #congestion-text {
        font-size: 1.6em;
      }

      .congestion-icon-section {
        width: 170px;
        height: 120px;
        padding: 12px 16px;
      }

      .wait-time {
        font-size: 2.2em;
      }

      .wait-label,
      .prediction-text {
        font-size: 1.6em;
      }

      .info-text {
        font-size: 1.0em;
        padding-left: 10px;
      }
    }
  </style>
</head>

<body class="{% if not is_logged_in %}login-mode{% endif %}">
  {% if not is_logged_in %}
  <div class="login-container">
    <h2>実証実験 プレテストへの参加<br>ありがとうございます</h2>
    <p>学籍番号とビブス番号を入力して<br>「開始」を押してください。</p>
    <form method="POST" action="/monitor">
      <input type="text" name="student_id" class="login-input" placeholder="学籍番号" required autofocus>
      <input type="number" name="bib_number" class="login-input" placeholder="ビブスNo." required>
      <br><button type="submit" class="login-button">開始</button>
    </form>
  </div>
  {% else %}
  <div class="container">
    <div class="title">食堂混雑状況</div>
    <div class="info-text">最終更新 : <span id="last-update">--:--</span></div>
    <div class="info-text" id="service-time">食事提供 : 11:30〜13:30</div>
    <div class="menu-text"><a href="https://aimgrp-lgf.jp/0002243" target="_blank" rel="noopener noreferrer"
        aria-label="食堂のメニューを新しいタブで開く">メニューはこちらから</a></div>

    <div class="wait-time-section">
      <div class="wait-label">現在の待ち時間</div>
      <div class="wait-time" id="wait-time">--分 --秒</div>
      <div class="congestion-icon-section">
        <div id="congestion-icons"><i class="fa-solid fa-person"></i></div>
        <div id="congestion-text">データ取得中...</div>
      </div>
      <div id="error-message" style="display: none; color: #dc3545; margin-top: 15px; font-size: 1.2em;">データ取得に失敗しました
      </div>
    </div>

    <div id="pred-crowd-area" class="prediction-text">
      <span id="pred-crowd-val">--</span>後は今より混みます
    </div>
    <div id="pred-empty-area" class="prediction-text">
      <span id="pred-empty-val">--</span>後は今より空いています
    </div>
  </div>

  <script>
    const API_URL = "/api/congestion";
    const UPDATE_INTERVAL = 30000;
    let intervalTimer;

    function updateCongestionVisuals(waitMinutesFloat) {
      const iconsEl = document.getElementById("congestion-icons");
      const textEl = document.getElementById("congestion-text");
      const sectionEl = document.querySelector(".congestion-icon-section");
      const waitEl = document.getElementById("wait-time");
      if (!iconsEl || !textEl || !sectionEl || !waitEl) return;

      const iconActive = '<i class="fa-solid fa-person"></i>';
      const iconInactive = '<i class="fa-solid fa-person icon-inactive"></i>';

      sectionEl.classList.remove("level-1", "level-2", "level-3", "level-off");
      waitEl.classList.remove("level-1", "level-2", "level-3", "level-off");

      if (isNaN(waitMinutesFloat)) {
        iconsEl.innerHTML = '<i class="fa-solid fa-shop-slash icon-inactive"></i>';
        textEl.textContent = "提供時間外";
        sectionEl.classList.add("level-off");
        waitEl.classList.add("level-off");
      } else if (waitMinutesFloat <= 2) {
        iconsEl.innerHTML = iconActive + iconInactive + iconInactive;
        textEl.textContent = "空いています";
        sectionEl.classList.add("level-1");
        waitEl.classList.add("level-1");
      } else if (waitMinutesFloat <= 4) {
        iconsEl.innerHTML = iconActive + iconActive + iconInactive;
        textEl.textContent = "やや混雑";
        sectionEl.classList.add("level-2");
        waitEl.classList.add("level-2");
      } else {
        iconsEl.innerHTML = iconActive + iconActive + iconActive;
        textEl.textContent = "混雑";
        sectionEl.classList.add("level-3");
        waitEl.classList.add("level-3");
      }
    }

    async function updateDisplay() {
      try {
        const res = await fetch(API_URL + '?t=' + new Date().getTime());
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const data = await res.json();
        // console.log("取得データ:", data);

        // --- 時間処理 (修正版: last_clip_ts を使用) ---
        const rawTimeStr = data.last_clip_ts;
        let formattedTime = "--:--";
        if (rawTimeStr) {
          // 例: "2025-12-08T13:59:11" をパース
          const dateObj = new Date(rawTimeStr);
          if (!isNaN(dateObj.getTime())) {
            formattedTime = dateObj.getHours().toString().padStart(2, '0') + ":" + dateObj.getMinutes().toString().padStart(2, '0');
          }
        }

        const lastUpdateEl = document.getElementById("last-update");
        if (lastUpdateEl) lastUpdateEl.textContent = formattedTime;

        // --- 待ち時間表示 ---
        const displayMinutes = data.display_minutes !== undefined ? data.display_minutes : 0;
        const displaySeconds = data.display_seconds !== undefined ? data.display_seconds : 0;
        const waitTimeEl = document.getElementById("wait-time");

        if (waitTimeEl) {
          const secStr = displaySeconds.toString().padStart(2, '0');
          waitTimeEl.textContent = `${displayMinutes} 分 ${secStr} 秒`;
        }

        // --- 混雑予報テキスト更新 ---
        const crowdArea = document.getElementById("pred-crowd-area");
        const emptyArea = document.getElementById("pred-empty-area");
        const crowdVal = document.getElementById("pred-crowd-val");
        const emptyVal = document.getElementById("pred-empty-val");

        if (crowdArea) crowdArea.style.display = "none";
        if (emptyArea) emptyArea.style.display = "none";

        if (data.forecast_text === "increase") {
          if (crowdArea) {
            crowdArea.style.display = "block";
            crowdVal.textContent = data.forecast_val;
          }
        } else if (data.forecast_text === "decrease") {
          if (emptyArea) {
            emptyArea.style.display = "block";
            emptyVal.textContent = data.forecast_val;
          }
        }

        // 色とアイコンの更新
        updateCongestionVisuals(data.wait_minutes);

        // エラーメッセージを非表示
        const errorMsg = document.getElementById("error-message");
        if (errorMsg) errorMsg.style.display = "none";

      } catch (e) {
        console.error("データ取得エラー:", e);
        // エラーメッセージを表示
        const errorMsg = document.getElementById("error-message");
        if (errorMsg) errorMsg.style.display = "block";
      }
    }

    // ページ離脱時にタイマーをクリーンアップ
    window.addEventListener('beforeunload', () => {
      if (intervalTimer) clearInterval(intervalTimer);
    });

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function () {
        updateDisplay();
        intervalTimer = setInterval(updateDisplay, UPDATE_INTERVAL);
      });
    } else {
      updateDisplay();
      intervalTimer = setInterval(updateDisplay, UPDATE_INTERVAL);
    }
  </script>
  {% endif %}
</body>

</html>