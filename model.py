from datetime import datetime

# ==========================================
# ★モデル設定エリア (分析結果の反映)
# ==========================================
# 画像の係数 (b0〜b6) を設定
MODEL_COEFFS = {
    'b0': 2.03,    # 切片
    'b1': 0.685,   # W(T): 現在の行列人数
    'b2': -1.53,   # in_1: 退室数(合計)と仮定
    'b3': -0.341,  # in_2: 入室数(合計)と仮定
    'b4': 4.44,    # d1: 12:00-12:20
    'b5': 10.8,    # d2: 12:20-12:40 (ピーク)
    'b6': 10.6     # d3: 12:40-13:00
}

# 時間変換の設定 (人数 ÷ この数字 ＝ 分)
PEOPLE_PER_MINUTE = 6.66


# ==========================================
# 予測ロジック関数
# ==========================================

def predict_model2(current_dt, e_k, e_s, l_k, l_s, c_m):
    """
    画像の重回帰式に基づいた予測ロジック
    W(T+5) = b0 + b1*W(T) + b2*in_1 + b3*in_2 + b4*d1 + b5*d2 + b6*d3
    """
    
    # 1. 時間帯ダミー (d1, d2, d3) の判定
    d1 = 0
    d2 = 0
    d3 = 0
    
    t = current_dt.time()
    
    # 境界時刻の設定
    t_1200 = datetime.strptime("12:00", "%H:%M").time()
    t_1220 = datetime.strptime("12:20", "%H:%M").time()
    t_1240 = datetime.strptime("12:40", "%H:%M").time()
    t_1300 = datetime.strptime("13:00", "%H:%M").time()

    if t_1200 <= t < t_1220:
        d1 = 1
    elif t_1220 <= t < t_1240:
        d2 = 1
    elif t_1240 <= t < t_1300:
        d3 = 1

    # 2. 変数の集約
    # ★修正箇所: 引数名 (l_k, l_s, e_k, e_s) を使うように修正しました
    
    # b2 (-1.53) -> 退室(L)
    in_1_val = l_k + l_s   # ここを修正しました
    
    # b3 (-0.341) -> 入室(E)
    in_2_val = e_k + e_s   # ここを修正しました
    
    # W(T) は現在の行列人数
    w_t = c_m

    # 3. 計算実行
    c = MODEL_COEFFS
    
    pred_people = (
        c['b0'] +
        c['b1'] * w_t +
        c['b2'] * in_1_val +
        c['b3'] * in_2_val +
        c['b4'] * d1 +
        c['b5'] * d2 +
        c['b6'] * d3
    )
    
    # 人数がマイナスにならないよう補正
    return max(0, pred_people)